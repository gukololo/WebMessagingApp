<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Main Page</title>
  <style>
    :root{ --glass: rgba(0,0,0,.55); --radius:16px; }
    html, body { height:100%; margin:0; }
    body{
      min-height:100%;
      background: url('/static/ayi.jpg') center center / cover no-repeat fixed;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#fff;
    }
    .page{
      max-width: 1100px;
      width: min(95%, 1100px);
      margin: 6vh auto;
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
    }
    .card{
      background: var(--glass);
      backdrop-filter: blur(3px);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .sidebar{ padding:16px; display:flex; flex-direction:column; gap:12px; }
    .sidebar h2{ margin:0 0 8px; font-size:18px; opacity:.95; }
    .user-list{ list-style:none; margin:0; padding:0; display:grid; gap:8px; }
    .user{ padding:10px 12px; border-radius:10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); display:flex; align-items:center; gap:10px; }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.on  { background:#22c55e; box-shadow:0 0 0 3px rgba(34,197,94,.25); }
    .dot.off { background:#ef4444; box-shadow:0 0 0 3px rgba(239,68,68,.25); }
    .chat{ display:flex; flex-direction:column; min-height:70vh; }
    .chat-header{ padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.15); display:flex; align-items:center; justify-content:space-between; }
    .chat-header .hello{ font-size:18px; opacity:.95; }
    .messages{ flex:1; overflow:auto; padding:18px; display:flex; flex-direction:column; gap:10px; }
    .msg{ max-width:70%; padding:10px 12px; border-radius:12px; background:rgba(255,255,255,.10); border:1px solid rgba(255,255,255,.15); }
    .msg.me{ align-self:flex-end; background:rgba(59,130,246,.25); border-color:rgba(59,130,246,.45); }
    .msg.sys{ opacity:.85; font-style:italic; }
    .meta{ font-size:12px; opacity:.8; margin-bottom:4px; }
    .chat-input{ border-top:1px solid rgba(255,255,255,.15); padding:12px; display:flex; gap:10px; }
    .chat-input input[type="text"]{ flex:1; min-width:0; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff; outline:none; }
    .chat-input button{ padding:12px 16px; border-radius:12px; border:0; background:#3b82f6; color:#fff; font-weight:600; cursor:pointer; }
    .chat-input button:hover{ filter:brightness(1.1); }
    @media (max-width: 720px){ .page{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <main class="page">
    <aside class="sidebar card">
      <h2>Users</h2>
      <ul class="user-list" id="userList"></ul>
    </aside>

    <section class="chat card">
      <div class="chat-header">
        <div class="hello">Welcome, {{username}}</div>
      </div>

      <div class="messages" id="messages"></div>

      <form class="chat-input" id="chatForm" autocomplete="off">
        <input type="text" id="text" name="text" placeholder="Type a message...  (/add NAME  |  /remove NAME)" required>
        <button type="submit">Send</button>
      </form>
    </section>
  </main>

  <script>
    const username = "{{username}}";
    const $list = document.getElementById('userList');
    const $msgs = document.getElementById('messages');
    const $form = document.getElementById('chatForm');
    const $input = document.getElementById('text');

    function renderAllUsers(arr){
      $list.innerHTML = '';
      arr.forEach(({user, online}) => {
        const li = document.createElement('li');
        li.className = 'user';
        li.innerHTML = `<span class="dot ${online ? 'on':'off'}"></span><span class="name"></span>`;
        li.querySelector('.name').textContent = user;
        $list.appendChild(li);
      });
    }

    function appendMessage(user, text){
      const wrap = document.createElement('div');
      wrap.className = 'msg' + (user === username ? ' me' : '');
      wrap.innerHTML = `<div class="meta">${user}</div><div>${text}</div>`;
      $msgs.appendChild(wrap);
      $msgs.scrollTop = $msgs.scrollHeight;
    }
    function appendSystem(text){
      const wrap = document.createElement('div');
      wrap.className = 'msg sys';
      wrap.innerHTML = `<div class="meta">system</div><div>${text}</div>`;
      $msgs.appendChild(wrap);
      $msgs.scrollTop = $msgs.scrollHeight;
    }

    // Açılışta mevcut kullanıcıları al
    fetch('/users').then(r => r.json()).then(renderAllUsers);

    // SSE (kullanıcı adıyla) — sadece hedefe gelen mesajları göster
    const es = new EventSource('/events?user=' + encodeURIComponent(username));

    es.addEventListener('users', ev => {
      try { renderAllUsers(JSON.parse(ev.data)); } catch {}
    });

    es.addEventListener('msg', ev => {
      try {
        const m = JSON.parse(ev.data); // {user, text, to:[...]}
        const targets = Array.isArray(m.to) ? m.to : [];
        if (m.user === username || targets.includes(username)) {
          appendMessage(m.user, m.text);
        }
      } catch {}
    });

    es.addEventListener('sys', ev => {
      try {
        const s = JSON.parse(ev.data); // {text, to:[...]}
        const targets = Array.isArray(s.to) ? s.to : [];
        if (targets.length === 0 || targets.includes(username)) {
          appendSystem(s.text);
        }
      } catch {}
    });

    // Mesaj / komut gönder
    $form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = $input.value.trim();
      if(!text) return;
      fetch('/send', {
        method: 'POST',
        headers: {'Content-Type':'application/x-www-form-urlencoded'},
        body: 'user=' + encodeURIComponent(username) + '&text=' + encodeURIComponent(text)
      });
      $input.value = ''; $input.focus();
    });

    // Sekme/pencere tamamen kapanırken offline bildir (sekme değiştirince DEĞİL)
    function sendLeave() {
      const data = new Blob(
        ['user=' + encodeURIComponent(username)],
        { type: 'application/x-www-form-urlencoded' }
      );
      navigator.sendBeacon('/leave', data);
    }
    window.addEventListener('pagehide', sendLeave);
    window.addEventListener('beforeunload', sendLeave);
  </script>
</body>
</html>
